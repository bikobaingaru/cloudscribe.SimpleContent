$(function(){String.format=function(){for(var e=arguments[0],t=0;t<arguments.length-1;t++){var i=RegExp("\\{"+t+"\\}","gm")
e=e.replace(i,arguments[t+1])}return e}
var t={ui:{treeDiv:$("#tree1"),cmdBarDiv:$("#cmdBar"),selectedPageInput:$("#hdnSelPage"),cmdHeading:$("#cmdHeading"),sortLi:$("#liSort"),editLi:$("#liEdit"),deleteLi:$("#liDelete"),newChildLi:$("#liNewChild"),editLink:$("#lnkEdit"),viewLink:$("#lnkView"),sortButton:$("#lnkSort"),newChildLink:$("#lnkNewChild"),deleteButton:$("#lnkDeletePage"),pubStatusLabel:$("#spnPubStatus"),movePagePromptFormat:$("#config").data("move-prompt-format"),deletePagePromptFormat:$("#config").data("delete-prompt-format"),deletePageWithChildrenPromptFormat:$("#config").data("delete-with-children-prompt-format"),sortChildrenAlphaPagePromptFormat:$("#config").data("sort-children-alpha-prompt-format")},urls:{treeDataUrl:$("#config").data("service-url"),sortUrl:$("#config").data("sort-url"),moveUrl:$("#config").data("move-url"),deleteUrl:$("#config").data("delete-url"),editUrl:$("#config").data("edit-url"),newPageUrl:$("#config").data("new-page-url")},xsrfToken:$('[name="__RequestVerificationToken"]:first').val(),showCommands:function(e){t.ui.selectedPageInput.val(e.id),t.ui.cmdHeading.html(e.name),t.ui.editLink.attr("href",this.urls.editUrl+"/"+e.slug),t.ui.viewLink.attr("href",e.url),t.ui.newChildLink.attr("href",this.urls.newPageUrl+"?parentslug="+e.slug),t.ui.pubStatusLabel.html(e.pubstatus),t.ui.cmdBarDiv.show(),new Tether({element:".commandPanel",target:".jqtree-selected",attachment:"top left",targetAttachment:"top right"}),e.childcount>1?t.ui.sortLi.show():t.ui.sortLi.hide(),e.canEdit?t.ui.editLi.show():t.ui.editLi.hide(),e.canDelete?t.ui.deleteLi.show():t.ui.deleteLi.hide(),e.canCreateChild?t.ui.newChildLi.show():t.ui.newChildLi.hide()},moveNode:function(e,i,o,n){var r={}
r.movedNode=e.id,r.targetNode=i.id,r.previousParent=o.id,r.position=n
var a=!1
return $.ajax({type:"POST",url:t.urls.moveUrl,async:!1,headers:{"X-CSRFToken":this.xsrfToken},dataType:"json",data:r,success:function(e,t,i){e.success?a=!0:alert(e.message)},complete:function(e,t){},error:function(e,t,i){alert(i)}}),a},init:function(){this.ui.sortButton.click(function(e){e.preventDefault()
var i=t.ui.treeDiv.tree("getNodeById",t.ui.selectedPageInput.val()),o=String.format(t.ui.sortChildrenAlphaPagePromptFormat,i.name)
$("#confirmModalBody").html(o),$("#mdlConfirm").modal("show")
var n=function(){$("#mdlConfirm").modal("hide")
var e={}
e.pageId=i.id,$.ajax({type:"POST",url:t.urls.sortUrl,headers:{"X-CSRFToken":t.xsrfToken},async:!1,processData:!0,dataType:"json",data:e,success:function(e,o,n){e.success?t.ui.treeDiv.tree("loadDataFromUrl",i):alert(e.message)},complete:function(e,t){},error:function(e,t,i){alert(i)}})}
$("#btnConfirm").off("click").on("click",n)}),t.ui.deleteButton.click(function(e){e.preventDefault()
var i,o=t.ui.treeDiv.tree("getNodeById",t.ui.selectedPageInput.val())
i=o.childcount>0?String.format(t.ui.deletePageWithChildrenPromptFormat,o.name,o.name):String.format(t.ui.deletePagePromptFormat,o.name),$("#confirmDeleteModalBody").html(i),$("#mdlDelete").modal("show")
var n=function(){$("#mdlDelete").modal("hide")
var e={}
e.id=o.id,$.ajax({type:"POST",url:t.urls.deleteUrl,headers:{"X-CSRFToken":t.xsrfToken},async:!1,dataType:"json",data:e,success:function(e,i,n){e.success?(t.ui.treeDiv.tree("removeNode",o),t.ui.cmdBarDiv.hide()):alert(e.message)},complete:function(e,t){},error:function(e,t,i){alert(t)}})}
$("#btnConfirmDelete").off("click").on("click",n)}),t.ui.treeDiv.tree({dataUrl:t.urls.treeDataUrl,dragAndDrop:!0,onLoadFailed:function(e){alert(e)}}),t.ui.treeDiv.bind("tree.click",function(e){e.node}),t.ui.treeDiv.bind("tree.dblclick",function(t){console.log(e.node)}),t.ui.treeDiv.bind("tree.select",function(e){if(e.node)t.showCommands(e.node)
else{e.previous_node
t.ui.selectedPageInput.val(-1),t.ui.cmdBarDiv.hide()}}),t.ui.treeDiv.bind("tree.contextmenu",function(e){e.node}),t.ui.treeDiv.bind("tree.move",function(e){e.preventDefault()
var i=String.format(t.ui.movePagePromptFormat,e.move_info.moved_node.name,e.move_info.position,e.move_info.target_node.name)
$("#confirmModalBody").html(i),$("#mdlConfirm").modal("show")
var o=function(){return $("#mdlConfirm").modal("hide"),t.moveNode(e.move_info.moved_node,e.move_info.target_node,e.move_info.previous_parent,e.move_info.position)&&e.move_info.do_move(),!1}
$("#btnConfirm").off("click").on("click",o)}),t.ui.treeDiv.bind("tree.init",function(){}),t.ui.treeDiv.bind("tree.open",function(e){t.ui.treeDiv.tree("selectNode",null),t.ui.treeDiv.tree("selectNode",e.node)}),t.ui.treeDiv.bind("tree.close",function(e){t.ui.treeDiv.tree("selectNode",null),t.ui.treeDiv.tree("selectNode",e.node)})}}
t.init()})
